#### 注册中心的健康检查机制
主要是**两种**检查方式：
- **心跳**：**客户端主动**上报，告诉服务端自己健康状态，如果一段时间没有上报，那么认为服务已经不健康
- **主动探测**：**服务端主动**向客户端进行探测，检查客户端是否还能被探测到。
![](../../../img/Pasted%20image%2020240314173237.png)
#### Nacos健康检查机制
Nacos提供了两种服务类型供用户注册实例时选择，分为非持久化实例（**临时实例**）和持久化实例（**永久化实例**）。
**临时实例**只是临时存在于注册中心中，会在服务下线或不可用时被注册中心剔除，临时实例会与注册中心保持**心跳**，注册中心会在一段时间没有收到来自客户端的心跳后会将实例设置为不健康，然后在一段时间后进行剔除。
**永久实例**在被删除之前会永久的存在于注册中心，且有可能并不知道注册中心存在，不会主动向注册中心上报心跳，那么这个时候就需要**注册中心主动进行探活**。
##### 临时实例健康检查机制
在 Nacos 中，用户可以通过**两种方式**进行临时实例的注册，通过 Nacos 的 **OpenAPI 进行服务注册**或通过 Nacos 提供的 **SDK 进行服务注册**。
**OpenAPI 的注册方式**实际是用户根据自身需求**调用 Http 接口对服务进行注册**，然后通过 Http 接口发送心跳到注册中心。**在注册服务的同时会注册一个全局的客户端心跳检测的任务。在服务一段时间没有收到来自客户端的心跳后，该任务会将其标记为不健康，如果在间隔的时间内还未收到心跳，那么该任务会将其剔除。**
**SDK 的注册方式**实际是通过 **RPC 与注册中心保持连接**（Nacos 2.x 版本中，旧版的还是仍然通过 OpenAPI 的方式），**客户端会定时的通过 RPC 连接向 Nacos 注册中心发送心跳，保持连接的存活。如果客户端和注册中心的连接断开，那么注册中心会主动剔除该 client 所注册的服务，达到下线的效果。同时 Nacos 注册中心还会在注册中心启动时，注册一个过期客户端清除的定时任务，用于删除那些健康状态超过一段时间的客户端。**
![](../../../img/Pasted%20image%2020240314174149.png)
##### 永久实例健康检查机制
对于永久实例的的健康检查，**Nacos 采用的是注册中心探测机制，注册中心会在持久化服务初始化时根据客户端选择的协议类型注册探活的定时任务**。Nacos 现在内置提供了三种探测的协议，即 Http、TCP 以及 MySQL。
由于持久化服务的实例的在被主动删除前一直存在的特性，探活的定时任务会不断探测服务的健康状态，并且将无法探测成功的实例标记为不健康。但是有些时候会有这样的场景，有些服务不希望去校验其健康状态，**Nacos也是提供了对应的白名单配置，用户可以将服务配置到该白名单，那么 Nacos 会放弃对其进行健康检查，**实例的健康状态也始终为用户传入的健康状态。
#### 集群模式下的健康检查机制

对于集群下的服务，Nacos 一个服务只会被 Nacos 集群中的一个注册中心所负责，**其余节点的服务信息只是集群副本**，用于订阅者在查询服务列表时，始终可以获取到全部的服务列表。临时实例只会对其被负责的注册中心节点发送心跳信息，注册中心服务节点会对其负责的永久实例进行健康探测，在**获取到健康状态后由当前负责的注册中心节点将健康信息同步到集群中的其他的注册中心。**