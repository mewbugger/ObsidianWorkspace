#### 背景
Distro协议是Nacos社区自研的一种AP分布式协议，是面向临时实例设计的一种分布式协议，其保证了在某些Nacos节点宕机后，整个临时实例处理系统依旧可以正常工作。作为一种有状态的中间件应用的内嵌协议，Distro保证了各个Nacos节点对于海量注册请求的统一协调和存储。
#### 设计思想
Distro协议的**主要设计思想**：
- Nacos每个节点是**平等**的都可以**处理写请求**，同时把新数据同步到其他节点。
- 每个节点**只负责部分数据**，**定时发送**自己负责数据的校验值到其他节点来保持数据一致性。
- 每个节点**独立处理读请求**，及时从本地发出响应
#### 数据初始化
新加入的Distro节点会进行全量数据拉取。具体操作是**轮询所有**的Distro节点，**通过向其他的机器发送请求拉取全量数据**。
![](../../../img/Pasted%20image%2020240317015314.png)
全量拉取操作之后，Nacos的**每台机器**上都维护了当前的**所有**注册上来的临**时实例数据**。
#### 数据校验
在Distro集群启动之后，各台机器之间会**定期发送心跳**。心跳信息主要为各个机器上的所有数据的**元信息**（使用元信息的原因是，需要保证网络中数据传输的**量级**维持在一个较低水平）这种数据校验会以心跳的形式进行，即每台机器会**在固定时间间隔**向其他机器发起一次数据校验请求。
![](../../../img/Pasted%20image%2020240317015916.png)
一旦数据校验过程中，某台机器发现其他机器上的数据与本地**数据不一致**，会发起一次**全量拉取请求**，将**数据补齐**。
#### 写操作
对于一个已经启动完成的 Distro 集群，在一次客户端发起写操作的流程中，当注册非持久化的实例的写请求打到某台 Nacos 服务器时，Distro 集群处理的流程图如下：
![](../../../img/Pasted%20image%2020240317020241.png)
整个步骤包括几个部分（图中从上到下顺序）：
- 前置的 Filter 拦截请求，并根据请求中**包含的 IP 和 port 信息计算其所属的 Distro 责任节点**，并将该**请求转发**到所属的 Distro 责任节点上。
- 责任节点上的 **Controller 将写请求进行解析**。
- Distro 协议**定期执行 Sync** 任务，将本机所负责的所有的实例信息**同步到其他节点**上。
#### 读操作
由于**每台**机器上都存放了**全量数据**，因此在每一次读操作中，Distro 机器会直接**从本地拉取数据**。快速响应。
![](../../../img/Pasted%20image%2020240317020423.png)这种机制保证了 Distro 协议可以作为一种 AP 协议，对于读操作都进行及时的响应。在网络分区的情况下，对于所有的读操作也能够正常返回；当网络恢复时，各个 Distro 节点会把各数据分片的数据进行合并恢复。