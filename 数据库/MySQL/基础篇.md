#### 执行一条select语句，期间发生了什么
##### MySQL执行流程是怎样的
![](../../img/Pasted%20image%2020240328135900.png)
MySQL的架构共**分为两层**：**Server层**和**存储引擎层**
- **Server层**负责简历连接、分析和执行SQL
- **存储引擎层**负责数据的存储和提取
##### 第一步：连接器
1. **启动MySQL服务：** 在尝试连接前，需要确保MySQL服务已经在运行。如果服务没有启动，尝试连接时会收到错误提示。
2. **TCP三次握手**：由于MySQL基于TCP协议进行数据传输，连接过程首先会经历TCP的三次握手过程，以建立一个可靠的连接。如果MySQL服务未运行，这一步会失败，并返回错误。
3. **用户名和密码验证**：一旦 TCP 连接建立，MySQL 连接器会验证尝试连接的客户端提供的用户名和密码。如果提供的用户名或密码不正确，会收到“Access denied for user”的错误，并且客户端程序将停止执行。
4. **权限获取与保存**：如果用户名和密码验证通过，连接器将获取并保存该用户的权限。这意味着，对于该连接，所有后续的操作都会基于连接时获取的权限进行。
5. **权限修改不影响已建立连接**：一旦连接建立，并且用户的权限被读取和保存，这些权限在当前连接生命周期内不会改变。即使是管理员在用户已经建立连接后修改了用户的权限，对于该已经存在的连接来说，这些修改是不会生效的。任何权限的变更只会影响新建立的连接。
###### 空闲连接
MySQL 定义了**空闲连接**的**最大空闲时长**，由 `wait_timeout` 参数控制的，默认值是 8 小时（28880秒），如果空闲连接**超过了这个时间**，连接器就会**自动将它断开**。
###### 长连接和短连接
``` 
// 短连接
连接 mysql 服务（TCP 三次握手）
执行sql
断开 mysql 服务（TCP 四次挥手）

// 长连接
连接 mysql 服务（TCP 三次握手）
执行sql
执行sql
执行sql
....
断开 mysql 服务（TCP 四次挥手）
```
**长连接的好处**是可以减少建立连接和断开连接的过程，一般**推荐使用长连接**，但是使用长连接会导致内存占用增多
**解决长链接占用内存**问题：
1. 定期断开长连接
2. 客户端主动重置连接
##### 第二步：查询缓存（MySQL8.0已经不用了）
1. **查询缓存机制：** 当客户端向 MySQL 服务发送 SQL 语句时，如果是查询语句，MySQL 服务会首先检查查询缓存。查询缓存中以 key-value 形式存储之前的查询语句及其结果，其中 key 是 SQL 查询语句，value 是查询结果。
2. **缓存命中与否：** 如果发送的查询语句在查询缓存中有匹配（命中），MySQL 服务将直接返回缓存的查询结果给客户端，避免了再次执行查询语句的需要。如果没有命中，则需正常执行查询语句，并将结果存入查询缓存。
3. **查询缓存的局限性：** 查询缓存对于更新频繁的表效果不佳，因为任何表的更新操作都会导致相关查询缓存的清空。这意味着，尽管某些查询结果可能非常大并且刚被缓存，但表的任何更新操作都会导致这些缓存失效，这限制了查询缓存的实用性。
4. **MySQL 8.0 的变化：** 由于查询缓存的这些局限性，从 MySQL 8.0 版本开始，查询缓存功能被完全移除。这意味着，在 MySQL 8.0 及更高版本中，执行 SQL 查询语句不再涉及查询缓存这一阶段。
##### 第三步：解析SQL
在正式执行 SQL **查询语句之前**， MySQL 会先对 SQL 语句做解析，这个工作交由「**解析器**」来完成。
**解析器的任务**
1. **词法分析**：MySQL 会根据你输入的字符串识别出关键字出来，例如，SQL语句 select username from userinfo，在分析之后，会得到4个Token，其中有2个Keyword，分别为select和from
![](../../img/Pasted%20image%2020240328141802.png)
2. **语法分析**：根据词法分析的结果，语法解析器会根据语法规则，判断你输入的这个 SQL 语句是否满足 MySQL 语法，如果没问题就会构建出 SQL 语法树，这样方便后面模块获取 SQL 类型、表名、字段名、 where 条件等等。
![](../../img/Pasted%20image%2020240328141838.png)
##### 第四部：执行SQL
解析器后，开始执行SQL查询语句的流程，每条SELECT查询语句流程主要可以分为下面三个阶段：
- `prepare`：预处理阶段
- `optimize`：优化阶段
- `execute`：执行阶段
###### 预处理器
- 检查SQL查询语句中的表或者字段是否存在
- 将`select *` 中的 `*` 符号，扩展为表上的所有列
如果查询语句中**查的表不存在**，会在**prepare阶段中报错**。
###### 优化器
优化器主要负责将SQL查询语句的执行方案确定下来

###### 执行器
经历完优化器，确定了执行方案，就开始真正执行语句了。
有三种方式执行过程：
- **主键索引查询**：主键索引查询是指通过表的主键进行数据查询的操作。在数据库中，主键是表中每条记录的唯一标识符，而主键索引是一种特殊的索引，它直接映射到存储在磁盘上的数据记录。使用主键进行查询时，数据库可以利用这种索引快速定位到具体的数据行，这是因为**主键索引通常是按顺序存储的，使得查找效率非常高**。主键索引查询是最高效的查询方式之一，因为它可以直接通过索引找到数据，无需扫描额外的记录。
- **全表扫描**：全表扫描是指在查询过程中需要**遍历数据库表中的每一行数据来查找符合条件的记录。** 这种查询方式通常发生在没有适用的索引可用时，或者查询优化器判断使用索引的成本高于直接遍历全表的情况下。全表扫描效率相对较低，特别是在处理大型表时，因为它需要逐一检查表中的每条记录，直到找到所有符合条件的数据。全表扫描通常是数据库设计或查询优化需要改进的信号。
- **索引下推**：索引下推是 MySQL 5.6 及其以上版本引入的一项**查询优化技术**，它允许存储引擎在**使用二级索引进行查询时，更早地过滤不符合条件的记录**，从而减少不必要的数据访问和回表操作（即根据索引再去数据行中检索完整数据的过程）。在索引下推优化中，某些可以在索引层面评估的条件会被推送到存储引擎中，使得在确定哪些索引条目需要被访问时就能应用这些条件。这意味着，**如果索引中的列值不符合查询条件，数据库可以立即排除这些数据，而无需先回表取得完整记录再进行过滤**。索引下推能有效减少I/O操作和CPU使用，提高查询性能，尤其是在处理包含多条件查询和大量数据的表时。