#### 类的生命周期
类加载的过程包括了`加载`、`验证`、`准备`、`解析`、`初始化`五个阶段。在这五个阶段中，`加载`、`验证`、`准备`和`初始化`这四个阶段发生的顺序是确定的，而解析阶段则不一定，它在某种情况下可以在初始化阶段之后开始。
![](../../img/Pasted%20image%2020241017133410.png)
#### 1.类的加载
加载时类加载过程的第一个阶段，在加载阶段，虚拟机需要完成以下三件事情：
- 通过一个类的全限定名来获取其定义的二进制字节流。
- 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。
- 在Java堆中生存一个代表这个类的java.lang.Class对象，作为对方法区中这些数据的访问入口。
![](../../img/Pasted%20image%2020241017133710.png)
#### 2.类的连接
##### 验证：确保被加载的类的正确性
验证是连接阶段的第一步，这一阶段的目的是为了确保 Class文件的字节流中包含的信息符合当前虚拟机的要求，而且不会危害虚拟机自身的安全。验证阶段大致会完成**4个阶段的检验动作**：
- 文件格式验证
- 元数据验证
- 字节码验证
- 符号引用验证
##### 准备：为类的静态变量分配内存，并将其初始化为默认值。
准备阶段是正式为类变量分配内存并设置类变量初始值的阶段，这些内存都将在方法区中分配。对于该阶段有以下几点需要注意：
- 这时候进行内存分配的仅包括类变量（`static`），而不包括实例变量、实例变量会在对象实例化时随着对象一块分配在Java堆中。
- 这里所设置的初始值通常情况下是数据类型默认的零值（如`0`，`0L`，`null`，`false`）等，而不是被在Java代码中被显式地赋予的值。
假设一个类变量的定义为: `public static int value = 3`；那么变量value在准备阶段过后的初始值为`0`，而不是`3`，因为这时候尚未开始执行任何Java方法，而把value赋值为3的`put static`指令是在程序编译后，存放于类构造器`<clinit>()`方法之中的，所以把value赋值为3的动作将在初始化阶段才会执行。
**注意**如下几点：
- 对基本数据类型来说，对于**类变量(static)和全局变量**，如果不显式地对其赋值而直接使用，则系统会为其赋予默认的零值，而**对于局部变量**来说，在**使用前必须显式地为其赋值**，否则编译时不通过。
- 对于同时被`static`和`final`修饰的常量，**必须在声明的时候就为其显式地赋值**，否则编译时不通过；而只被final修饰的常量则既可以在声明时显式地为其赋值，也可以在类初始化时显式地为其赋值，总之，在**使用前必须为其显式地赋值，系统不会为其赋予默认零值**。
- 对于引用数据类型`reference`来说，如数组引用、对象引用等，如果没有对其进行显式地赋值而直接使用，系统都会为其赋予默认的零值，即`null`。
- 如果在数组初始化时没有对数组中的各元素赋值，那么其中的元素将根据对应的数据类型而被赋予默认的零值。
- 如果类字段的字段属性表中存在ConstantValue属性，即同时被final和static修饰，那么在准备阶段变量value就会被初始化为ConstValue属性所指定的值。假设上面的类变量value被定义为: `public static final int value = 3；`编译时Javac将会为value生成ConstantValue属性，在准备阶段虚拟机就会根据ConstantValue的设置将value赋值为3。我们可以理解为`static final`常量在编译期就将其结果放入了调用它的类的常量池中
##### 解析：把类中的符号引用转换为直接引用
解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程，解析动作主要针对`类`或`接口`、`字段`、`类方法`、`接口方法`、`方法类型`、`方法句柄`和`调用点`限定符7类符号引用进行。符号引用就是一组符号来描述目标，可以是任何字面量。

`直接引用`就是直接指向目标的指针、相对偏移量或一个间接定位到目标的句柄。

#### 3.类的初始化
##### 概念
初始化，为类的静态变量赋予正确的初始值，JVM负责对类进行初始化，主要对类变量进行初始化。在Java中对类变量进行初始值设定有两种方式：
- 声明类变量是指定初始值
- 使用静态代码块为类变量指定初始值
##### 步骤
- 假如这个类还没有被加载和连接，则程序先加载并连接该类
- 假如该类的直接父类还没有被初始化，则先初始化其父类（[问题1](../../基础/多态.md#问题1)）
- 假设类中有初始化语句，则系统依次执行这些初始化语句
流程图：
![](../../img/Pasted%20image%2020240121005621.png)
1. 父类静态初始化块
2. 子类静态初始化块
3. 父类初始化块
4. 父类构造器
5. 子类初始化块
6. 子类构造器
##### 类初始化时机
只有当对类的主动使用的时候才会导致类的初始化，类的主动使用包括以下六种：
- 创建类的实例，也就是new的方式
- 访问某个类或接口的静态变量，或者对该静态变量赋值
- 调用类的静态方法
- 反射
- 初始化某个类的子类，则其父类也会被初始化（[问题1](../基础/多态.md#问题1))
- Java虚拟机启动时被表明为启动类的类（Java Test），直接使用java.exe命令来运行某个主类