#### 运行时数据区
##### 字符串常量池
字符串常量池是JVM为了提升性能和减少内存消耗针对字符串（String类）专门开辟的一块区域，主要目的是为了字符串的重复创建。
示例如下：
``` java
// 在堆中创建字符串对象”ab“
// 将字符串对象”ab“的引用保存在字符串常量池中
String aa = "ab";
// 直接返回字符串常量池中字符串对象”ab“的引用
String bb = "ab";
System.out.println(aa==bb);// true

```
**JDK1.7之后**字符串常量池和静态变量从永久代（方法区）移动到Java堆中。**JDK1.8之后**，永久代被替换为元空间（方法区）。

##### 堆
###### 内存划分
Java堆事Java虚拟机管理的内存中最大的一块，被所有线程共享。此内存区域的**唯一目的就是存放对象实例**，几乎所有的对象实例以及数据都在这里分配内存。

虚拟机把对内存逻辑上分为三块区域，这样做的**唯一目的**是为了**优化垃圾回收性能**：
![](../../img/Pasted%20image%2020240218171551.png)

1. **新生代**：新对象和没达到一定年龄的对象都在新生代
新生代是所有新对象创建的地方。当填充新生代的时候，执行垃圾回收，这种垃圾回收被称为`Minor GC`。新生代被分为三个部分（一个伊甸园和两个幸存区，默认比例式8：1：1）
- 大多数新创建的对象都在伊甸园内存空间中。
- 当伊甸园空间被对象填充时，执行`Minor GC`，并将所有幸存者对象转移到一个幸存者内存空间中。
- `Minor GC`检查幸存者对象，并将它们移动到另一个幸存者空间。所以每次，一个幸存者空间总是空的。
-  经过多次 `GC` 循环后存活下来的对象被移动到老年代。通常，这是通过设置年轻一代对象的年龄阈值来实现的，然后他们才有资格提升到老一代
2. **老年代**：被长时间使用的对象，老年代的内存空间应该要比新生代更大
老年代内存包含那些经过许多轮小型GC后仍然存活的对象。通常，垃圾收集是在老年代内存满时执行的。老年代垃圾回收称为主GC（`Major GC`），通常需要更长的时间。
**大对象**（大对象是指需要大量连续内存空间的对象）**直接进入老年代**。这样做的目的是**避免在伊甸园和两个幸存区之间发生大量的内存拷贝**。
3. **元空间（1.8之前叫做永久代）**：像一些方法中的操作临时对象等，1.8之前是占用JVM内存，JDK1.8之后直接使用物理内存。
不管是 JDK8 之前的永久代，还是 JDK8 及以后的元空间，都可以看作是 Java 虚拟机规范中**方法区的实现**（[方法区](内存区域.md#方法区)）。
虽然 Java 虚拟机规范把方法区描述为堆的一个逻辑部分，但是它却有一个别名叫 `Non-Heap`（非堆），目的应该是与 Java 堆区分开。

###### 对象在堆中的生命周期
1. 在JVM内存模型的堆中，堆被划分为新生代和老年代
- 新生代被进一步划分为`Eden`和`Survivor`，`Survivor`由`From Survivor`和`To Survivor`组成
2. 当创建一个对象时，对象会被优先分配到新生代的Eden
- 此时JVM会给对象定义一个**对象年轻计数器**（`-XX:MaxTenuringThreshold`）
3. 当`Eden`空间不足时，JVM将执行新生代的垃圾回收（`Minor GC`）
- JVM会把存活的对象转移到`Survivo`r中，并且对象年龄+1
- 对象在`Survivor`中同样也会经历`Minor GC`，每经历一次Minor GC，对象年龄都会+1
4. 如果分配的对象超过了`-XX:PetenureSizeThreshold`，对象会被**直接分配到老年代**。
###### 对象的分配过程
1. new的对象先放在伊甸园，伊甸园有大小限制。
2. 伊甸园空间满的时候，程序又需要创建对象，JVM的垃圾回收器会对伊甸园进行垃圾回收（`Minor GC`），将伊甸园区中的不再被其他对象所引用的对象进行销毁。再加载新的对象放到伊甸园。
3. 然后将伊甸园中的剩余对象移动到幸存0区。
4. 如果再次触发垃圾回收，此时上次幸存下来的放到幸存0区，如果没有回收，就会放到幸存1区。
5. 如果再次经历垃圾回收，此时会重新放回幸存0区，接着再去幸存1区，如此循环，所以总有一个幸存区是空着。
6. 默认是15次回收标记的时候去老年代。
7. 老年代中，相对悠闲。当老年代内存不足，再次触发`Major GC`，进行老年代的内存清理。
8. 如果老年代执行了Major GC之后发现依然无法进行对象的保存，就会产生OOM异常。

##### 方法区
